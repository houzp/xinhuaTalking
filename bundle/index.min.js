'use strict';

/**
 * @Author: St. <SuperMoo>
 * @Date:   2016-12-27-20:31:24
 * @Email:  st_sister@iCloud.com
 * @Filename: index.js
* @Last modified by:   SuperMoo
* @Last modified time: 2016-12-27-20:40:07
 * @License: MIT
 * @Copyright: Copyright (c) Xinhuanet Inc. All rights reserved.
 */

$(function () {
    // 必要的全局对象
    var XHT = window.XHT;
    var $window = window.$window = $(window);
    var $body = window.$body = $('body');
    var cover = XHT.cover; // cover 组件
    var zoom = XHT.zoom;

    var scens1 = null;

    // loader
    var resources = [// 需要预加载的资源
    '../xinhuaTalking/index-assets/bg.jpg', '../xinhuaTalking/index-assets/cover-logo.png', '../xinhuaTalking/index-assets/scenes-1-btn-1-active-bg.png', '../xinhuaTalking/index-assets/scenes-1-btn-1-bg.png', '../xinhuaTalking/index-assets/demo-pic-0.png', '../xinhuaTalking/index-assets/demo-pic-1.png', '../xinhuaTalking/index-assets/demo-pic-2.png', '../xinhuaTalking/index-assets/demo-pic-3.png', '../xinhuaTalking/index-assets/demo-pic-4.png'];

    var loader = new resLoader({
        resources: resources,
        onStart: function onStart(total) {
            // console.log('start:' + total);
        },
        onProgress: function onProgress(current, total) {
            // console.log(current + '/' + total);
            // var percent = current / total * 100;
            // $('.progressbar').css('width', percent + '%');
            // $('.progresstext .current').text(current);
            // $('.progresstext .total').text(total);
        },
        onComplete: function onComplete(total) {
            // xinhuaTalking
            xinhuaTalking.init();
        }
    });

    var xinhuaTalking = {
        $nav: $('#nav'),
        navHeight: 67,
        scenesMain_realIndex: 0,
        $scenes1: $('#scenes-1'),
        scenes1: null,
        init: function init() {
            var _this = this;

            new cover({
                // tag: $('#cover1'), //主目标
                // isOff: 1, //开关
                // hashKey: 'no-cover', //不显示封面的hash关键字
                // aniTime: 4, // TweenMax动画时间
                // delay: 2000, //
            });

            // swiper
            _this.scenesMain = new Swiper('#main', {
                lazyLoading: true,
                speed: 1000,
                hashnav: true,
                direction: 'vertical',
                keyboardControl: true,
                mousewheelControl: true,
                // onSlideChangeStart
                onInit: function onInit(swiper) {
                    // getSwiperData
                    _this.getSwiperData();
                    // getSize
                    _this.getSize();
                    // nav
                    _this.navHeight = _this.$nav.height();

                    $window.on('resize', function () {
                        if (_this.scenesMain_realIndex < 1) {
                            _this.getSize();
                        }
                        _this.navStatus(_this.scenesMain_realIndex);
                    });
                    // scenes_1_init
                    _this.scenes1_init();
                },
                onSlideChangeStart: function onSlideChangeStart(swiper) {
                    console.log(swiper.realIndex);
                    _this.scenesMain_realIndex = swiper.realIndex;
                    _this.navStatus(swiper.realIndex);
                },
                onSlideChangeEnd: function onSlideChangeEnd(swiper) {
                    // scenes_1_init
                    _this.scenes1_init();
                }
            });
        },
        scenes1_init: function scenes1_init() {
            var _this = this;
            if (_this.scenesMain_realIndex === 0) {

                new zoom({
                    id: _this.$scenes1,
                    array: [{
                        tag: '.scenes-1-logo'
                    }, {
                        tag: '.scenes-1-title-top'
                    }, {
                        tag: '.scenes-1-title-1'
                    }, {
                        tag: '.scenes-1-title-4'
                    }, {
                        tag: '.scenes-1-content'
                    }]
                });

                if (_this.scenes1 === null) {
                    console.log('scenes_1_init start');
                    _this.scenes1 = new Swiper('#scenes-1', {
                        lazyLoading: true,
                        autoplay: 8000,
                        loop: true,
                        parallax: true,
                        pagination: '#scenes-1 .swiper-pagination',
                        prevButton: '#scenes-1 .swiper-button-prev',
                        nextButton: '#scenes-1 .swiper-button-next',
                        paginationClickable: true,
                        speed: 2000,
                        onInit: function onInit(swiper) {
                            _this.qrcode();

                            swiper.nextButton.addClass('active').on('mouseout', function () {
                                swiper.nextButton.removeClass('active');
                            });

                            swiper.prevButton.on('mouseout mouseover', function () {
                                swiper.nextButton.removeClass('active');
                            });
                        },
                        onSlideChangeStart: function onSlideChangeStart(swiper) {
                            var num = [swiper.realIndex - 1, swiper.realIndex + 1];
                            if (num[0] < 0) {
                                num[0] = _this.data.length - 1;
                            }
                            if (num[1] >= _this.data.length) {
                                num[1] = 0;
                            }
                            _this.setSwiperButton(swiper.prevButton, num[0]);
                            _this.setSwiperButton(swiper.nextButton, num[1]);
                        }
                    });
                } else {
                    _this.scenes1.unlockSwipes();
                }
            } else {
                if (_this.scenes1 !== null) {
                    _this.scenes1.lockSwipes();
                }
            }
        },
        getSwiperData: function getSwiperData() {
            var _this = this;
            _this.data = new Array();
            _this.$scenes1.find('.swiper-slide').each(function (i, e) {
                var $e = $(e);
                _this.data.push({
                    title: $.trim($e.find('.scenes-1-title-1').text()),
                    img: $e.find('.scenes-1-pic img').attr('src')
                });
            });
        },
        setSwiperButton: function setSwiperButton($tag, num) {
            var _this = this;
            $tag.html('\n                    <div class="swiper-button-content">\n                        <div class="p">\n                            <img src="' + _this.data[num].img + '" width="102" height="auto">\n                        </div>\n                        <div class="t">' + _this.data[num].title + '</div>\n                    </div>\n                    <div class="icon"></div>\n                    <div class="b"></div>');
        },
        getSize: function getSize() {
            this.size = {
                height: $window.height(),
                width: $window.width()
            };
        },
        qrcode: function qrcode() {
            var qrcodes = this.$scenes1.find('.scenes-1-qrcode');
            qrcodes.each(function (i, e) {
                var $e = $(e);
                $e.qrcode({
                    correctLevel: 1,
                    // background: "#999",
                    foreground: "#333", //"#0099ff"
                    width: 108,
                    height: 108,
                    text: $.trim($e.find('.scenes-1-qrcode-url').text())
                });
            });
        },
        navPos: function navPos(num, time, callback) {
            TweenMax.to(this.$nav, time, {
                top: num,
                bottom: 'auto',
                onComplete: callback || null
            });
        },
        navStatus: function navStatus(scenesMain_realIndex) {
            var _this = this;
            if (scenesMain_realIndex < 1) {
                _this.navPos(_this.size.height - _this.navHeight, 0.6, function () {
                    _this.$nav.removeClass('nav-isTop');
                });
            } else {
                _this.navPos(0, 0.6, function () {
                    _this.$nav.addClass('nav-isTop');
                });
            }
        }
    };

    // 读取开始
    loader.start();
});
