'use strict';

/**
 * @Author: St. <SuperMoo>
 * @Date:   2016-11-29-11:15:57
 * @Email:  st_sister@iCloud.com
 * @Filename: index.js
* @Last modified by:   SuperWoods
* @Last modified time: 2016-12-05-15:14:23
 * @License: MIT
 * @Copyright: Copyright (c) Xinhuanet Inc. All rights reserved.
 */

$(function () {
    var $window = $(window);
    var $body = $('body');

    var media_$tag = null;
    var media_size = {};
    // let media_index = 0;
    var windowScrollTop = 0;
    var swiper = null;

    // 设置 parallax ------------------------------------------------------------
    var $parallaxScene = $('#parallax-scene');

    var isAboveIE9 = window.BROWSER.browser !== 'oldie' && window.BROWSER.browser !== 'ie9';
    var isPC = window.BROWSER.device !== 'iphone' && window.BROWSER.device !== 'android';
    // 初始化parallax
    if (isAboveIE9) {
        // $body.append(`
        //         <script src="bundle/swiper.min.js"></script>
        //         <script src="bundle/jquery.parallax.min.js"></script>
        //         `);
        $parallaxScene.parallax();
        swiper = new Swiper('#part-item-pic', {
            loop: true,
            pagination: '.swiper-pagination',
            prevButton: '.swiper-button-prev',
            nextButton: '.swiper-button-next',
            // effect: 'cube',
            effect: 'coverflow',
            grabCursor: true,
            centeredSlides: true,
            slidesPerView: 'auto',
            coverflow: {
                rotate: 60,
                stretch: 90,
                depth: 500,
                modifier: 1,
                slideShadows: true
            }
        });
    } else {
        // < ie10 提示
        $body.append('\n                <!--[if lt IE 10]>\n                    <div class="ie-tip">\u4E3A\u8FBE\u5230\u66F4\u4F73\u6D4F\u89C8\u6548\u679C\uFF0C\u8BF7\u4F7F\u7528chrome\u3001Safari\u3001firefox\u3001IE9\u53CA\u4EE5\u4E0A\u6D4F\u89C8\u5668</div>\n                <![endif]-->');
    }

    // 添加行和间距 br
    $('.part-text .abs br').after('<br>&#8195;&#8195;');

    // // 写入人物文字
    // if (window.BROWSER.device !== 'iphone' && window.BROWSER.device !== 'android') {
    //     $parallaxScene
    //         .find('.person-img-title')
    //         .text($parallaxScene.find('.person-img-text').text());
    // }


    // if (window.BROWSER.browser === 'oldie' || window.BROWSER.browser === 'ie9') {
    //
    // }


    // 设置 banner 背景 ---------------------------------------------------------
    // $parallaxScene
    //     .find('.banner')
    //     .css({
    //         'background-image': `url(${$parallaxScene.find('.part-bg img').attr('src')})`,
    //     });

    // 设置 #part 第一条引号为灰色-------------------------------------------------
    var $part = $('#part');
    $part.find('.part-item:eq(0)').addClass('gray');

    // 写入头像 -----------------------------------------------------------------
    var setAvatar = function setAvatar(opt) {
        var $tag = opt.$tag;
        var list = opt.$list;
        $tag.each(function (i, e) {
            var $e = $(e);
            var n = $.trim($e.text()) - 0 - 1;
            // console.log(n, $e.text());
            // console.log(n >= 0);
            // console.log(n < list.length);
            // console.log(n !== '');
            if (n >= 0 && n < list.length) {
                $e.after(list.eq(n).clone());
            } else {
                if (opt.isRemove && opt.isRemove === true) {
                    $e.parent().remove();
                } else {
                    var clasName = 'part-no-avatar';
                    if (opt.isNoClass && opt.isNoClass !== '') {
                        clasName = opt.isNoClass;
                    }
                    $e.after('<div class="' + clasName + '">\u6682\u65E0\u5934\u50CF</div>');
                }
            }
        });
    };
    setAvatar({
        $tag: $('.part-avatar-img-num'),
        $list: $('#part-avatar-imgs').find('img'),
        isRemove: 'remove'
    });

    // 媒体数据检查 --------------------------------------------------------------
    var checkMedia = function checkMedia($tag) {
        var obj = {};
        // set src
        var src = $tag.find('.src-string');
        if (src.length > 0) {
            var srcText = src.text();
            var keywords = {
                http: 'http://',
                vid: '?vid'
            };
            var isHttp = srcText.indexOf(keywords.http) !== -1;
            var isVid = srcText.lastIndexOf(keywords.vid) !== -1;

            console.log(isHttp && isVid);

            if (isHttp && isVid) {
                obj.type = 'video';
                obj.src = $.trim(srcText);
            }
        }
        // set title
        var title = $tag.find('.title-string');
        if (title.length > 0) {
            obj.title = $.trim(title.text());
        }
        // set poster
        var img = $tag.find('img');
        if (img.length > 0) {
            obj.poster = img.attr('src');
        }
        // console.log('checkMedia ', obj);
        return obj;
    };

    // 对话框 -------------------------------------------------------------------
    var $dialogTag = $('#dialog-video');

    // 实例化对话框
    var dialog = $dialogTag.dialog({
        autoOpen: false,
        height: 425,
        width: 640,
        resizable: true,
        modal: false,
        // show: {
        //     effect: "zoom",
        //     duration: 800
        // },
        close: function close() {
            $('.isVideoPlay').remove();
        }
    });

    // 移动版 mobileIframeHieght
    var mobileIframeHieght = null;

    // 对话框处理器
    var dialogHandler = function dialogHandler(config) {
        // 获取目标
        var $tag = config.$tag;
        // 获取播放数据
        var media = checkMedia($tag);
        // 如果是视频
        if (media && media.type === 'video') {
            (function () {
                $tag.addClass('isVideo');

                var iframeDOM = '<iframe class="isVideoPlay" frameborder="0" scrolling="no" width="100%" height="' + (isPC ? '100%' : mobileIframeHieght === null ? mobileIframeHieght = $window.width() * 9 / 16 : mobileIframeHieght) + '" src="' + media.src + '"></iframe>';

                if (isPC) {
                    // 装载 dialog
                    dialog.dialog({
                        // modal: true,
                        position: {
                            of: $tag
                        },
                        open: function open() {
                            $dialogTag.html(iframeDOM);
                        }
                    });
                    // config.button
                    // let $btn = $tag;
                    // if (config.button && config.button === true) {
                    //     $btn = $tag.button();
                    // }
                    // click
                    $tag.on("click", function () {
                        if (dialog.dialog("isOpen")) {
                            dialog.dialog("close");
                        }
                        media_$tag = $tag;
                        dialog.dialog({
                            height: 425,
                            width: 640,
                            position: {
                                my: "center top",
                                at: "center top",
                                of: $tag
                            },
                            title: media.title
                        });
                        dialog.dialog("open");
                        // media_index = config.i;
                        media_size = {
                            top: Math.round($tag.offset().top),
                            bottom: $window.height() - $tag.height(),
                            index: config.i
                        };
                    });
                } else {
                    $tag.on("click", function () {
                        $tag.html(iframeDOM).removeClass('isVideo');
                    });
                }
            })();
        } else {
            // isNoBtn
            $tag.removeClass('isVideo');
        }
    };

    // 批量装载对话框
    var $dialogMedia = $body.find('.dialog-media');
    if ($dialogMedia.length) {
        (function () {

            $dialogMedia.each(function (i, e) {
                dialogHandler({
                    $tag: $(e),
                    i: i
                });
            });

            // // 获取第一个 $dialogMedia
            // const dialogMedia0_offsetTop = $dialogMedia.eq(0).offset().top;
            // // const isZoom = (status) => {
            // //     if (!status) {
            // //         return media_index === 0;
            // //     } else {
            // //         return true;
            // //     }
            // // };

            // 返回顶部按钮处理器
            var backTopHandler = {
                css: {
                    width: 50,
                    // height: '60',
                    position: 'fixed',
                    right: 10,
                    bottom: 20,
                    'padding-top': '10px',
                    'z-index': 99
                },
                $tag: null,
                isTop: false,
                set: function set(opt) {
                    this.isTop = opt.windowScrollTop < 800;
                    if (this.$tag !== null) {
                        if (this.isTop) {
                            this.hide();
                        } else {
                            this.show();
                        }
                    } else {
                        this.add();
                        this.events();
                    }
                },
                add: function add() {
                    $body.append('\n                    <div id="backTopBtn" class="hide">\n                        <div class="ui-button ui-corner-all ui-widget" style="padding:.6em 0; width: 48px;">\n                            <span class="ui-icon ui-icon-arrowthickstop-1-n"></span>\n                        </div>\n                    </div>');
                    this.$tag = $('#backTopBtn');
                    this.$tag.css(this.css);
                    // console.log('this.isTop', this.isTop);
                    if (this.isTop === false) {
                        this.show();
                    }
                },
                events: function events() {
                    var _this = this;
                    _this.$tag.on('click', function () {
                        $body.animate({
                            scrollTop: 0
                        }, '3000', function () {
                            _this.hide();
                        });
                    });
                },
                hide: function hide() {
                    this.$tag.fadeOut('1000');
                },
                show: function show() {
                    this.$tag.fadeIn('1000');
                }
            };

            // 第一屏视频滚动缩放控制器
            if (isAboveIE9) {
                $window.on('scroll', function () {

                    windowScrollTop = $window.scrollTop();

                    if (dialog.dialog("isOpen")) {
                        // console.log(media_size, windowScrollTop);
                        if (media_size.top < windowScrollTop || media_size.top > media_size.bottom + windowScrollTop) {

                            var isTop = backTopHandler.isTop === true;

                            dialog.dialog({
                                height: 256,
                                width: 320,
                                position: {
                                    my: "right bottom",
                                    at: isTop ? "right bottom" : "right top",
                                    of: isTop ? $window : backTopHandler.$tag
                                }
                            });
                        } else {

                            dialog.dialog({
                                height: 425,
                                width: 640,
                                position: {
                                    my: "center top",
                                    at: "center top",
                                    of: media_$tag
                                }
                            });
                        }
                    }

                    backTopHandler.set({
                        windowScrollTop: windowScrollTop
                    });
                });
            }
        })();
    }
});
